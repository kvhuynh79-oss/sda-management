import jsPDF from "jspdf";

export interface ConsentFormParams {
  orgName: string;
  orgAbn?: string;
  participantName: string;
  ndisNumber: string;
  dob: string;
  propertyAddress: string;
}

/**
 * Generate a 2-page Consent to Collect, Use and Share Personal Information PDF.
 * Page 1: Consent form with clauses, signature blocks.
 * Page 2: Privacy Information Sheet (Your Privacy Rights).
 * Complies with Australian Privacy Principle 3 (APP 3).
 */
export function generateConsentFormPdf(params: ConsentFormParams): void {
  const { orgName, orgAbn, participantName, ndisNumber, dob, propertyAddress } = params;
  const doc = new jsPDF();
  const pageWidth = doc.internal.pageSize.getWidth();
  const margin = 18;
  const contentWidth = pageWidth - margin * 2;

  // ── PAGE 1: CONSENT FORM ──────────────────────────────────

  // Header bar
  doc.setFillColor(13, 148, 136); // teal-600
  doc.rect(0, 0, pageWidth, 36, "F");

  doc.setTextColor(255, 255, 255);
  doc.setFontSize(10);
  doc.setFont("helvetica", "normal");
  doc.text(orgName, margin, 14);
  doc.text(orgAbn ? `ABN: ${orgAbn}` : "", margin, 20);

  doc.setFontSize(14);
  doc.setFont("helvetica", "bold");
  doc.text("Consent to Collect, Use and Share Personal Information", margin, 30);

  // Participant details section
  let y = 46;
  doc.setTextColor(0, 0, 0);
  doc.setFontSize(11);
  doc.setFont("helvetica", "bold");
  doc.text("Participant Details", margin, y);
  y += 8;

  doc.setFontSize(10);
  doc.setFont("helvetica", "normal");

  const detailRows = [
    { label: "Full Name:", value: participantName },
    { label: "NDIS Number:", value: ndisNumber },
    { label: "Date of Birth:", value: dob },
    { label: "Property Address:", value: propertyAddress },
  ];

  for (const row of detailRows) {
    doc.setFont("helvetica", "bold");
    doc.text(row.label, margin, y);
    doc.setFont("helvetica", "normal");
    doc.text(row.value || "N/A", margin + 40, y);
    y += 6;
  }

  // Divider
  y += 4;
  doc.setDrawColor(200, 200, 200);
  doc.setLineWidth(0.3);
  doc.line(margin, y, pageWidth - margin, y);
  y += 8;

  // Consent clauses
  doc.setFontSize(11);
  doc.setFont("helvetica", "bold");
  doc.text("Consent Clauses", margin, y);
  y += 8;

  const clauses = [
    "I consent to the collection of my personal and health information for the purpose of managing my SDA tenancy.",
    "I understand my information may be shared with NDIS, SIL providers, and support coordinators as necessary.",
    "I have been informed of my right to access, correct, or request deletion of my personal information.",
    "I understand this consent is valid for 12 months from the date signed and can be withdrawn at any time.",
    "I have read the Privacy Information Sheet (overleaf) and understand how my information will be handled.",
  ];

  doc.setFontSize(9.5);
  doc.setFont("helvetica", "normal");

  for (let i = 0; i < clauses.length; i++) {
    // Checkbox graphic
    const checkboxX = margin;
    const checkboxY = y - 3;
    doc.setDrawColor(80, 80, 80);
    doc.setLineWidth(0.5);
    doc.rect(checkboxX, checkboxY, 4, 4);

    // Clause text with word wrap
    const lines = doc.splitTextToSize(
      `${i + 1}. ${clauses[i]}`,
      contentWidth - 8
    );
    doc.text(lines, margin + 7, y);
    y += lines.length * 5 + 4;
  }

  // Divider before signatures
  y += 4;
  doc.setDrawColor(200, 200, 200);
  doc.setLineWidth(0.3);
  doc.line(margin, y, pageWidth - margin, y);
  y += 10;

  // Signature block
  doc.setFontSize(11);
  doc.setFont("helvetica", "bold");
  doc.text("Declaration & Signatures", margin, y);
  y += 10;

  doc.setFontSize(9);
  doc.setFont("helvetica", "normal");
  doc.text(
    "By signing below, I confirm that I have read and understood the above clauses and the Privacy Information Sheet.",
    margin,
    y
  );
  y += 12;

  // Participant signature line
  doc.setDrawColor(0, 0, 0);
  doc.setLineWidth(0.4);
  doc.line(margin, y + 8, margin + 80, y + 8);
  doc.setFontSize(8);
  doc.text("Participant / Authorised Representative Signature", margin, y + 13);

  // Date line
  doc.line(margin + 100, y + 8, margin + 150, y + 8);
  doc.text("Date", margin + 100, y + 13);

  y += 24;

  // Witness signature line
  doc.setLineWidth(0.4);
  doc.line(margin, y + 8, margin + 80, y + 8);
  doc.setFontSize(8);
  doc.text("Witness Name & Signature", margin, y + 13);

  // Witness date
  doc.line(margin + 100, y + 8, margin + 150, y + 8);
  doc.text("Date", margin + 100, y + 13);

  // Footer
  const footerY = doc.internal.pageSize.getHeight() - 12;
  doc.setFontSize(7);
  doc.setTextColor(120, 120, 120);
  doc.text(
    "Complies with Australian Privacy Principle 3 (APP 3) - Collection of solicited personal information",
    margin,
    footerY
  );
  doc.text(
    `Generated by MySDAManager on ${new Date().toLocaleDateString("en-AU")}`,
    margin,
    footerY + 4
  );
  doc.text("Page 1 of 2", pageWidth - margin - 20, footerY + 4);

  // ── PAGE 2: PRIVACY INFORMATION SHEET ──────────────────────
  doc.addPage();

  // Header bar
  doc.setFillColor(13, 148, 136); // teal-600
  doc.rect(0, 0, pageWidth, 30, "F");

  doc.setTextColor(255, 255, 255);
  doc.setFontSize(14);
  doc.setFont("helvetica", "bold");
  doc.text("Privacy Information Sheet", margin, 20);

  y = 40;
  doc.setTextColor(0, 0, 0);

  // Section helper
  const addSection = (title: string, content: string) => {
    doc.setFontSize(11);
    doc.setFont("helvetica", "bold");
    doc.text(title, margin, y);
    y += 7;

    doc.setFontSize(9);
    doc.setFont("helvetica", "normal");
    const lines = doc.splitTextToSize(content, contentWidth);
    doc.text(lines, margin, y);
    y += lines.length * 4.5 + 6;
  };

  addSection(
    "Your Privacy Rights",
    "Under the Australian Privacy Act 1988 and the NDIS Act 2013, you have the right to know what personal " +
      "information we collect, why we collect it, who we share it with, and how you can access or correct your information. " +
      "This sheet explains these rights in plain language."
  );

  addSection(
    "What We Collect and Why",
    "We collect your personal information (name, contact details, NDIS number, date of birth) and health information " +
      "(SDA needs, disability support requirements) to:\n" +
      "- Manage your SDA tenancy and accommodation agreement\n" +
      "- Process SDA funding claims with the NDIS\n" +
      "- Coordinate with your SIL provider and support coordinator\n" +
      "- Meet our regulatory and reporting obligations\n" +
      "- Ensure the safety and suitability of your accommodation"
  );

  addSection(
    "Who We Share Your Information With",
    "We may share your information with:\n" +
      "- The National Disability Insurance Agency (NDIA) for funding and compliance purposes\n" +
      "- Your nominated SIL provider for daily support coordination\n" +
      "- Your Support Coordinator or Plan Manager as required\n" +
      "- Occupational Therapists conducting SDA assessments\n" +
      "- Emergency services when required for your safety\n" +
      "- Government bodies where legally required\n\n" +
      "We will never sell your personal information or share it for marketing purposes."
  );

  addSection(
    "How We Store Your Information",
    "Your information is stored securely in our digital management system with encryption at rest. " +
      "Access is restricted to authorised staff only. We retain your information for 7 years after your " +
      "tenancy ends, as required by NDIS record-keeping obligations."
  );

  addSection(
    "How to Withdraw Consent",
    "You can withdraw your consent at any time by contacting your property manager or SDA provider in writing. " +
      "If you withdraw consent:\n" +
      "- We will stop collecting new personal information\n" +
      "- Your NDIS number, date of birth, and emergency contacts will be archived\n" +
      "- Records required for legal or compliance purposes will be retained\n" +
      "- This may affect our ability to manage your SDA tenancy and process NDIS claims"
  );

  addSection(
    "How to Access or Correct Your Information",
    "You have the right to request access to your personal information at any time. " +
      "If you believe any information is incorrect, you can request a correction. " +
      "Contact your SDA provider directly to make a request."
  );

  addSection(
    "Making a Complaint",
    "If you believe your privacy has been breached, you can:\n" +
      "1. Contact us directly to lodge a complaint\n" +
      "2. Contact the NDIS Quality and Safeguards Commission: 1800 035 544\n" +
      "3. Contact the Office of the Australian Information Commissioner (OAIC):\n" +
      "   Phone: 1300 363 992 | Website: www.oaic.gov.au"
  );

  // Footer
  const footer2Y = doc.internal.pageSize.getHeight() - 12;
  doc.setFontSize(7);
  doc.setTextColor(120, 120, 120);
  doc.text(
    `${orgName} | Generated by MySDAManager on ${new Date().toLocaleDateString("en-AU")}`,
    margin,
    footer2Y
  );
  doc.text("Page 2 of 2", pageWidth - margin - 20, footer2Y);

  // ── PAGES 3-4: EASY READ VERSION ──────────────────────────

  addEasyReadPages(doc, { orgName, participantName, pageWidth, margin, contentWidth });

  // Trigger download
  const safeName = participantName.replace(/[^a-zA-Z0-9]/g, "_");
  const dateStr = new Date().toISOString().split("T")[0];
  doc.save(`Consent_Form_${safeName}_${dateStr}.pdf`);
}

/**
 * Generate a standalone Easy Read consent form PDF (2 pages).
 * Designed for participants with intellectual disabilities or cognitive impairments.
 * Uses short sentences, simple words, and clear headings per Easy Read guidelines.
 */
export function generateEasyReadConsentPdf(params: ConsentFormParams): void {
  const { orgName, participantName } = params;
  const doc = new jsPDF();
  const pageWidth = doc.internal.pageSize.getWidth();
  const margin = 18;
  const contentWidth = pageWidth - margin * 2;

  addEasyReadPages(doc, { orgName, participantName, pageWidth, margin, contentWidth, startPage: 1 });

  const safeName = participantName.replace(/[^a-zA-Z0-9]/g, "_");
  const dateStr = new Date().toISOString().split("T")[0];
  doc.save(`Consent_Form_Easy_Read_${safeName}_${dateStr}.pdf`);
}

// ── Shared Easy Read page builder ──────────────────────────

function addEasyReadPages(
  doc: jsPDF,
  opts: {
    orgName: string;
    participantName: string;
    pageWidth: number;
    margin: number;
    contentWidth: number;
    startPage?: number;
  }
): void {
  const { orgName, participantName, pageWidth, margin, contentWidth, startPage } = opts;
  const p1 = startPage ?? 3;
  const p2 = p1 + 1;
  const totalPages = startPage ? 2 : 4;
  const isStandalone = startPage === 1;

  // ── EASY READ PAGE 1: CONSENT ──────────────────────────
  // In standalone mode, jsPDF already created page 1 — don't add another
  if (!isStandalone) {
    doc.addPage();
  }

  // Purple header for Easy Read distinction
  doc.setFillColor(109, 40, 217); // purple-600
  doc.rect(0, 0, pageWidth, 36, "F");

  doc.setTextColor(255, 255, 255);
  doc.setFontSize(9);
  doc.setFont("helvetica", "normal");
  doc.text("EASY READ VERSION", margin, 12);
  doc.text(orgName, margin, 18);

  doc.setFontSize(16);
  doc.setFont("helvetica", "bold");
  doc.text("Saying Yes to Sharing Your Information", margin, 30);

  let y = 46;
  doc.setTextColor(0, 0, 0);

  // Intro
  doc.setFontSize(11);
  doc.setFont("helvetica", "normal");
  const introLines = doc.splitTextToSize(
    "This form is about your personal information. We need some of your information to help you with your home. You can say yes or no. It is your choice.",
    contentWidth
  );
  doc.text(introLines, margin, y);
  y += introLines.length * 5.5 + 6;

  // Easy Read consent points
  const easyReadClauses = [
    {
      heading: "1. We will collect some of your information",
      text: "We will collect information about you. This includes your name, your NDIS number, and your health needs. We use this to help you live in your home.",
    },
    {
      heading: "2. We may share your information with people who help you",
      text: "Sometimes we need to share your information. We may share it with the NDIS, your SIL provider, or your support coordinator. We only share what is needed.",
    },
    {
      heading: "3. You can see your information or change it",
      text: "You can ask to see the information we have about you. If something is wrong, you can ask us to fix it. You can also ask us to delete it.",
    },
    {
      heading: "4. This form lasts for 12 months",
      text: "When you sign this form, it lasts for 12 months. After that, we will ask you again. You can change your mind at any time.",
    },
    {
      heading: "5. We will look after your information",
      text: "We keep your information safe and private. The next page tells you more about this.",
    },
  ];

  for (const clause of easyReadClauses) {
    // Heading with bullet marker
    doc.setFillColor(109, 40, 217);
    doc.circle(margin + 1.5, y - 1.2, 1.5, "F");

    doc.setFontSize(11);
    doc.setFont("helvetica", "bold");
    doc.text(clause.heading, margin + 5, y);
    y += 6;

    doc.setFontSize(10);
    doc.setFont("helvetica", "normal");
    const lines = doc.splitTextToSize(clause.text, contentWidth - 5);
    doc.text(lines, margin + 5, y);
    y += lines.length * 5 + 5;
  }

  // Divider
  doc.setDrawColor(200, 200, 200);
  doc.setLineWidth(0.3);
  doc.line(margin, y, pageWidth - margin, y);
  y += 8;

  // Signature section
  doc.setFontSize(10);
  doc.setFont("helvetica", "normal");
  const sigIntro = doc.splitTextToSize(
    "By signing below, you are saying yes to these 5 things. You can bring a support person to help you understand this form.",
    contentWidth
  );
  doc.text(sigIntro, margin, y);
  y += sigIntro.length * 5 + 8;

  // Name line
  doc.setDrawColor(0, 0, 0);
  doc.setLineWidth(0.4);
  doc.setFontSize(9);
  doc.setFont("helvetica", "bold");
  doc.text("Name:", margin, y);
  doc.line(margin + 20, y, margin + 100, y);
  y += 10;

  // Signature + date
  doc.text("Signature:", margin, y);
  doc.line(margin + 24, y, margin + 80, y);
  doc.text("Date:", margin + 95, y);
  doc.line(margin + 110, y, margin + 150, y);
  y += 10;

  // Witness
  doc.text("Witness:", margin, y);
  doc.line(margin + 22, y, margin + 80, y);
  doc.text("Date:", margin + 95, y);
  doc.line(margin + 110, y, margin + 150, y);

  // Footer
  const footerY = doc.internal.pageSize.getHeight() - 12;
  doc.setFontSize(7);
  doc.setFont("helvetica", "normal");
  doc.setTextColor(120, 120, 120);
  doc.text("Easy Read - Complies with APP 3", margin, footerY);
  doc.text(`Page ${p1} of ${totalPages}`, pageWidth - margin - 20, footerY);

  // ── EASY READ PAGE 2: PRIVACY INFO ──────────────────────
  doc.addPage();

  // Purple header
  doc.setFillColor(109, 40, 217);
  doc.rect(0, 0, pageWidth, 30, "F");

  doc.setTextColor(255, 255, 255);
  doc.setFontSize(9);
  doc.setFont("helvetica", "normal");
  doc.text("EASY READ VERSION", margin, 12);
  doc.setFontSize(14);
  doc.setFont("helvetica", "bold");
  doc.text("Your Privacy Information", margin, 24);

  y = 38;
  doc.setTextColor(0, 0, 0);

  // Helper for Easy Read sections
  const addEasySection = (title: string, bullets: string[]) => {
    doc.setFillColor(109, 40, 217);
    doc.rect(margin, y - 3.5, contentWidth, 7, "F");
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(10);
    doc.setFont("helvetica", "bold");
    doc.text(title, margin + 3, y + 1);
    y += 8;

    doc.setTextColor(0, 0, 0);
    doc.setFontSize(9.5);
    doc.setFont("helvetica", "normal");
    for (const bullet of bullets) {
      const lines = doc.splitTextToSize(`\u2022  ${bullet}`, contentWidth - 6);
      doc.text(lines, margin + 3, y);
      y += lines.length * 4.5 + 1.5;
    }
    y += 3;
  };

  addEasySection("Your Privacy Rights", [
    "You have the right to know what information we have about you",
    "You have the right to say no to sharing your information",
    "You have the right to make a complaint if you are unhappy",
    "The law protects your information",
  ]);

  addEasySection("What We Collect and Why", [
    "Your name, date of birth, and contact details",
    "Your NDIS number and plan information",
    "Your health needs and disability information",
    "We collect this so we can support you in your home",
  ]);

  addEasySection("Who We Share Your Information With", [
    "The NDIS (National Disability Insurance Scheme)",
    "Your SIL provider (the people who help you day to day)",
    "Your support coordinator",
    "Doctors or therapists if needed for your safety",
    "We will never share your information without a good reason",
  ]);

  addEasySection("How We Keep Your Information Safe", [
    "We store your information on secure computers",
    "Only staff who need it can see your information",
    "We follow the Australian Privacy Principles",
  ]);

  addEasySection("How to Change Your Mind", [
    "You can tell us to stop using your information at any time",
    "Call us or tell a staff member",
    "We will not treat you differently if you say no",
  ]);

  addEasySection("Making a Complaint", [
    "If you are unhappy, tell us first and we will try to fix it",
    "You can also call the OAIC: 1300 363 992",
    "Or the NDIS Commission: 1800 035 544",
    "A friend, family member, or advocate can help you",
  ]);

  // Footer
  const footer2Y = doc.internal.pageSize.getHeight() - 12;
  doc.setFontSize(7);
  doc.setTextColor(120, 120, 120);
  doc.text(
    `${orgName} | Easy Read | Generated on ${new Date().toLocaleDateString("en-AU")}`,
    margin,
    footer2Y
  );
  doc.text(`Page ${p2} of ${totalPages}`, pageWidth - margin - 20, footer2Y);
}
